---
import '../styles/global.css';
import { getCollection } from 'astro:content';

// 1. Ambil data koleksi dari src/content/teams
const allBatches = await getCollection('teams');

// 2. Inisialisasi objek teamData
const teamData: any = {};

/** * Mengurutkan batch (Batch terbaru di paling atas)
 * Menggunakan toUpperCase() agar sorting tidak kacau karena huruf besar/kecil
 */
const sortedBatches = allBatches.sort((a: any, b: any) => {
  const titleA = (a.data.title || "").toUpperCase();
  const titleB = (b.data.title || "").toUpperCase();
  return titleB.localeCompare(titleA);
});

/** * Memetakan data dengan proteksi format foto dari Decap CMS
 */
sortedBatches.forEach((batch: any) => {
  const data = batch.data;
  if (!data.title) return;

  const batchKey = data.title;
  teamData[batchKey] = {};
  
  if (data.roles && Array.isArray(data.roles)) {
    data.roles.forEach((r: any) => {
      if (!r.photos) {
        teamData[batchKey][r.role_name] = [];
        return;
      }

      // Deteksi otomatis: apakah array string atau array object {url: "..."}
      const processedPhotos = r.photos.map((p: any) => {
        if (typeof p === 'string') return p; 
        if (p && typeof p === 'object' && p.url) return p.url;
        // Fallback jika strukturnya aneh
        return null; 
      }).filter(Boolean); // Hapus nilai null/undefined

      teamData[batchKey][r.role_name] = processedPhotos;
    });
  }
});
---

<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teams | Life at PIH</title>
    <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@300;800&display=swap" rel="stylesheet">
    
    <style is:global>
        :root { 
            --pih-blue: #1b509b; 
            --pih-dark: #0f2854; 
            --white: #ffffff;
        }
        
        body { 
            font-family: 'Funnel Display', sans-serif; 
            background: var(--pih-blue); 
            color: white; 
            margin: 0; 
            overflow-x: hidden; 
        }

        header { padding: 60px 20px; text-align: center; }
        .main-title { font-size: 8vw; font-weight: 800; line-height: 0.8; letter-spacing: -0.05em; margin: 0; }
        .italic-text { font-style: italic; font-weight: 100; opacity: 0.8; }

        .teams-app { max-width: 900px; margin: 0 auto; padding: 0 20px 180px 20px; }
        
        .batch-container { margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; overflow: hidden; background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .batch-trigger { 
            width: 100%; padding: 25px; background: none; border: none; color: white;
            font-size: 1.5rem; font-weight: 800; cursor: pointer; display: flex; 
            justify-content: space-between; align-items: center; transition: 0.3s;
        }
        .batch-trigger:hover { background: rgba(255,255,255,0.1); }
        .batch-trigger span { transition: transform 0.3s ease; }

        .batch-content { display: none; flex-direction: column; padding: 20px; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.1); }
        
        .roles-nav { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .role-btn { 
            padding: 10px 20px; border: 1px solid white; background: transparent; 
            color: white; border-radius: 30px; cursor: pointer; font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 0.1em; transition: 0.3s;
        }
        .role-btn:hover, .role-btn.active { background: white; color: var(--pih-blue); font-weight: bold; }

        .slider-section { position: relative; width: 100%; overflow: hidden; }
        .slider-viewport { width: 100%; overflow: hidden; padding: 10px 0; }
        .slider-inner { display: flex; gap: 20px; will-change: transform; align-items: center; }
        .slider-inner img { width: 250px; height: 350px; object-fit: cover; flex-shrink: 0; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); background: rgba(255,255,255,0.1); }

        .nav-controls { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; }
        .nav-btn { width: 45px; height: 45px; border-radius: 50%; border: 1px solid white; background: transparent; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; font-size: 1.2rem; }
        .nav-btn:hover:not(:disabled) { background: white; color: var(--pih-dark); }
        .nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }

        /* FLOATING DOCK STYLES */
        .dock-wrapper { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; z-index: 1000; }
        .toolbar { display: inline-flex; justify-content: center; align-items: center; height: 65px; border-radius: 22px; padding: 0 15px; background-color: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); list-style: none; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.3); margin: 0; }
        .toolbarItem { width: 45px; height: 45px; margin: 0 6px; position: relative; display: flex; align-items: center; justify-content: center; }
        .toolbarLink { display: flex; height: 100%; width: 100%; text-decoration: none; align-items: center; justify-content: center; background: white; border-radius: 12px; color: var(--pih-dark); transition: transform 0.3s ease, background 0.3s ease; }
        .toolbarLink:hover { transform: translateY(-5px); background: #f0f0f0; }
        .tooltip { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 5px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; opacity: 0; transition: opacity 0.2s; white-space: nowrap; pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .toolbarItem:hover .tooltip { opacity: 1; }

        
    </style>
</head>
<body>

    <header>
        <h1 class="main-title">PIH Hall of Fame</h1>
    </header>

    <main class="teams-app" id="teams-app" data-teams={JSON.stringify(teamData)}>
        {Object.entries(teamData).length === 0 ? (
            <div style="text-align: center; padding: 100px 0; opacity: 0.5;">Belum ada data tim yang ditemukan.</div>
        ) : (
            Object.entries(teamData).map(([batch, roles]) => (
                <div class="batch-container" data-batch={batch}>
                    <button class="batch-trigger">
                        {batch} <span>▾</span>
                    </button>
                    
                    <div class="batch-content">
                        <div class="roles-nav">
                            {Object.keys(roles as object).map((role) => (
                                <button class="role-btn" data-role={role}>
                                    {role}
                                </button>
                            ))}
                        </div>

                        <div class="slider-section">
                            <div class="slider-viewport">
                                <div class="slider-inner">
                                    <p class="placeholder" style="opacity: 0.5; width: 100%; text-align: center; padding: 60px 0;">Pilih role untuk melihat tim</p>
                                </div>
                            </div>
                            <div class="nav-controls">
                                <button class="nav-btn prev-btn" disabled>←</button>
                                <button class="nav-btn next-btn" disabled>→</button>
                            </div>
                        </div>
                    </div>
                </div>
            ))
        )}
    </main>

    <nav class="dock-wrapper">
        <ul class="toolbar">
            <li class="toolbarItem">
                <a class="toolbarLink" href="/">
                    <span class="tooltip">Home</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </a>
            </li>
            <li class="toolbarItem">
                <a class="toolbarLink" href="/teams" style="background: var(--pih-dark); color: white;">
                    <span class="tooltip">Hall of Fame</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </a>
            </li>
            <li class="toolbarItem">
                <a class="toolbarLink" href="/guideline">
                    <span class="tooltip">Guidelines</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><circle cx="12" cy="12" r="4"/></svg>
                </a>
            </li>
        </ul>
    </nav>

    <script>
        import { gsap } from "gsap";

        // Logic Slider
        const appElement = document.getElementById("teams-app") as HTMLElement;
        const teamData = JSON.parse(appElement.dataset.teams || "{}");

        document.querySelectorAll('.batch-container').forEach(container => {
            const trigger = container.querySelector('.batch-trigger') as HTMLButtonElement;
            const content = container.querySelector('.batch-content') as HTMLElement;
            const sliderInner = container.querySelector('.slider-inner') as HTMLElement;
            const nextBtn = container.querySelector('.next-btn') as HTMLButtonElement;
            const prevBtn = container.querySelector('.prev-btn') as HTMLButtonElement;
            const batchName = container.getAttribute('data-batch')!;

            let currentIndex = 0;
            let totalImages = 0;

            trigger.addEventListener('click', () => {
                const isOpen = content.style.display === 'flex';
                content.style.display = isOpen ? 'none' : 'flex';
                const arrow = trigger.querySelector('span');
                if (arrow) arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
            });

            container.querySelectorAll('.role-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const role = btn.getAttribute('data-role')!;
                    const images = teamData[batchName][role] || [];
                    
                    currentIndex = 0;
                    totalImages = images.length;
                    
                    container.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    sliderInner.innerHTML = "";
                    gsap.set(sliderInner, { x: 0 });
                    
                    if (totalImages === 0) {
                        sliderInner.innerHTML = '<p style="opacity:0.5; width:100%; text-align:center; padding:60px 0;">Belum ada foto untuk role ini</p>';
                    } else {
                        images.forEach((src: string) => {
                            const img = document.createElement("img");
                            img.src = src;
                            img.alt = role;
                            img.loading = "lazy";
                            img.onerror = () => { img.src = 'https://placehold.co/250x350?text=Foto+Bermasalah'; };
                            sliderInner.appendChild(img);
                        });
                    }
                    updateNav();
                });
            });

            function updateNav() {
                if (!prevBtn || !nextBtn) return;
                prevBtn.disabled = currentIndex === 0;
                nextBtn.disabled = currentIndex >= totalImages - 1 || totalImages <= 1;
            }

            function move(dir: number) {
                if ((dir === 1 && currentIndex < totalImages - 1) || (dir === -1 && currentIndex > 0)) {
                    currentIndex += dir;
                    gsap.to(sliderInner, { x: -currentIndex * 270, duration: 0.5, ease: "back.out(1.2)" });
                    updateNav();
                }
            }

            nextBtn.addEventListener('click', () => move(1));
            prevBtn.addEventListener('click', () => move(-1));
        });

        // Dock Animation (Sederhana agar ringan)
        const toolbar = document.querySelector(".toolbar");
        const items = document.querySelectorAll(".toolbarItem");
        
        if (toolbar) {
            toolbar.addEventListener("mouseleave", () => {
                gsap.to(items, { scale: 1, x: 0, duration: 0.3 });
            });
        }
    </script>
</body>
</html>