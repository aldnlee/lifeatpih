---
import '../styles/global.css';
import { getCollection } from 'astro:content';

// 1. Ambil data koleksi
const allBatches = await getCollection('teams');

// 2. Inisialisasi objek teamData
const teamData: any = {};

/** * Gunakan tipe data eksplisit (a: any, b: any) 
 * untuk memperbaiki error pada fungsi .sort() 
 */
const sortedBatches = allBatches.sort((a: any, b: any) => 
  b.data.title.localeCompare(a.data.title)
);

/** * Gunakan (batch: any) untuk memperbaiki error 
 * pada fungsi .forEach() 
 */
sortedBatches.forEach((batch: any) => {
  const data = batch.data;
  teamData[data.title] = {};
  
  data.roles.forEach((r: any) => {
    // Ambil property .url dari tiap object di dalam array photos
    teamData[data.title][r.role_name] = r.photos.map((p: any) => p.url);
  });
});
---
---

<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teams | Life at PIH</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Playfair+Display:ital,wght@0,900;1,900&family=Funnel+Display:wght@300;800&display=swap" rel="stylesheet">
    
    <style is:global>
        :root { --pih-blue: #1b509b; --pih-dark: #0f2854; }
        body { font-family: 'Funnel Display', sans-serif; background: var(--pih-blue); color: white; margin: 0; overflow-x: hidden; }

        header { padding: 60px 20px; text-align: center; }
        .main-title { font-size: 6vw; font-weight: 800; line-height: 0.8; letter-spacing: -0.05em; }
        .italic-text { font-style: italic; font-weight: 100; margin-right: 4px; }

        .teams-app { max-width: 900px; margin: 0 auto; padding-bottom: 150px; }
        
        .batch-container { margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; overflow: hidden; background: rgba(255,255,255,0.05); }
        .batch-trigger { 
            width: 100%; padding: 25px; background: none; border: none; color: white;
            font-size: 1.5rem; font-weight: 800; cursor: pointer; display: flex; 
            justify-content: space-between; align-items: center; transition: 0.3s;
        }

        .batch-content { display: none; flex-direction: column; padding: 20px; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.1); }
        
        /* Roles Navigation */
        .roles-nav { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .role-btn { 
            padding: 10px 20px; border: 1px solid white; background: transparent; 
            color: white; border-radius: 30px; cursor: pointer; font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 0.1em; transition: 0.3s;
        }
        .role-btn:hover, .role-btn.active { background: white; color: var(--pih-blue); }

        /* Slider Styles */
        .slider-section { position: relative; width: 100%; overflow: hidden; }
        .slider-viewport { width: 100%; overflow: hidden; padding: 10px 0; }
        .slider-inner { display: flex; gap: 20px; will-change: transform; }
        .slider-inner img { width: 250px; flex-shrink: 0; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        .nav-controls { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .nav-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid white; background: transparent; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .nav-btn:hover { background: white; color: var(--pih-dark); }
        .nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }

        /* Dock Style */
        .dock-wrapper { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; }
        .toolbar { list-style: none; display: flex; gap: 15px; background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); padding: 12px 25px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); margin: 0; }
        .toolbarLink { display: flex; align-items: center; justify-content: center; width: 45px; height: 45px; background: white; border-radius: 12px; color: var(--pih-dark); transition: 0.3s; }
        .toolbarLink:hover { transform: translateY(-5px); background: var(--pih-blue); color: white; }
    </style>
</head>
<body>

    <header>
        <h1 class="main-title">PIH Intern <span class="italic-text">and</span> KKN</h1>
    </header>

    <main class="teams-app" id="teams-app" data-teams={JSON.stringify(teamData)}>
        {Object.entries(teamData).map(([batch, roles]) => (
            <div class="batch-container" data-batch={batch}>
                <button class="batch-trigger">
                    {batch} <span>▾</span>
                </button>
                
                <div class="batch-content">
                    <div class="roles-nav">
                        {Object.keys(roles as object).map((role) => (
                            <button class="role-btn" data-role={role}>
                                {role}
                            </button>
                        ))}
                    </div>

                    <div class="slider-section">
                        <div class="slider-viewport">
                            <div class="slider-inner">
                                <p class="placeholder" style="opacity: 0.5; width: 100%; text-align: center;">Pilih role untuk melihat tim</p>
                            </div>
                        </div>
                        <div class="nav-controls">
                            <button class="nav-btn prev-btn" disabled>←</button>
                            <button class="nav-btn next-btn" disabled>→</button>
                        </div>
                    </div>
                </div>
            </div>
        ))}
    </main>

    <nav class="dock-wrapper">
        <ul class="toolbar">
            <li><a href="/" class="toolbarLink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a></li>
            <li><a href="/teams" class="toolbarLink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></a></li>
            <li><a href="/guideline" class="toolbarLink"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5Z"/><path d="M8 7h6"/><path d="M8 11h8"/></svg></a></li>
        </ul>
    </nav>

    <script>
        import { gsap } from "gsap";

        // Inisialisasi Data dari Astro
        const appElement = document.getElementById("teams-app") as HTMLElement;
        const teamData = JSON.parse(appElement.dataset.teams || "{}");

        // Logika Slider & Dropdown
        document.querySelectorAll('.batch-container').forEach(container => {
            const trigger = container.querySelector('.batch-trigger') as HTMLButtonElement;
            const content = container.querySelector('.batch-content') as HTMLElement;
            const sliderInner = container.querySelector('.slider-inner') as HTMLElement;
            const nextBtn = container.querySelector('.next-btn') as HTMLButtonElement;
            const prevBtn = container.querySelector('.prev-btn') as HTMLButtonElement;
            const batchName = container.getAttribute('data-batch')!;

            let currentIndex = 0;
            let totalImages = 0;

            trigger.addEventListener('click', () => {
                const isOpen = content.style.display === 'flex';
                content.style.display = isOpen ? 'none' : 'flex';
            });

            container.querySelectorAll('.role-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const role = btn.getAttribute('data-role')!;
                    const images = teamData[batchName][role];
                    
                    currentIndex = 0;
                    totalImages = images.length;
                    
                    container.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Render Gambar Slider
                    sliderInner.innerHTML = "";
                    gsap.set(sliderInner, { x: 0 });
                    
                    images.forEach((src: string) => {
                        const img = document.createElement("img");
                        img.src = src;
                        sliderInner.appendChild(img);
                    });

                    updateNav();
                });
            });

            function updateNav() {
                if (!prevBtn || !nextBtn) return;
                prevBtn.disabled = currentIndex === 0;
                nextBtn.disabled = currentIndex >= totalImages - 1 || totalImages <= 1;
            }

            function move(dir: number) {
                currentIndex += dir;
                // Geser 250px (lebar img) + 20px (gap)
                gsap.to(sliderInner, { x: -currentIndex * 270, duration: 0.6, ease: "power2.out" });
                updateNav();
            }

            nextBtn.addEventListener('click', () => move(1));
            prevBtn.addEventListener('click', () => move(-1));
        });
    </script>
</body>
</html>